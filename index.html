<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Reflection</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Daily Reflection">
    <meta name="description" content="Daily reflection app for sharing what's great and challenging each day">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiM2NjdlZWEiLz4KPHBhdGggZD0iTTkwIDQ1TDk4LjI1IDkxLjk3NUwxNDUgMTAwTDk4LjI1IDEzNS4wMjVMOTAgMTgxTDgxLjc1IDEzNS4wMjVMMzUgMTAwTDgxLjc1IDkxLjk3NUw5MCA0NVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkRhaWx5IFJlZmxlY3Rpb24iLAogICJzaG9ydF9uYW1lIjogIkRhaWx5IFJlZmxlY3Rpb24iLAogICJkZXNjcmlwdGlvbiI6ICJEYWlseSByZWZsZWN0aW9uIGFwcCBmb3Igc2hhcmluZyB3aGF0J3MgZ3JlYXQgYW5kIGNoYWxsZW5naW5nIGVhY2ggZGF5IiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiM2NjdlZWEiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWlJSFpwWlhkQ2IzZzlJakFnTUNBMU1USWdOVEV5SWlCbWFXeHNQU0p1YjI1bElpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBnbzhjbVZqZENCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUlpSUhKNFBTSTRNQ0lpSUdacGJHdzlJaU0yTmpkbFpXRWlMejRLUEhCaGRHZ2dSRDBpVFRJMU5pQXlOVFl5TlRJME5pNDJORFF1TmpNME1UazBOaTQyTmkwM09ESXVNamxNTWpNM0xqa3lOamc1VXpJd01TNDJPQzAwTmpndU1qRk1NakEzTGpNek5EUTBMak0yVFRFMk9DNDJOamN4T0RNdU5qWTFURGt5TGpsM1l6azNMamd0TmpJdU5USnROams0TGpjeUxUSTJOeTQ0TlMwNU9TNDBOaTF3ZFRjMmRURXdNaTQxT1RsRGJqUXhOUzQ0T1MwMk1qZ3VOVEY=IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNalUySWlCb1pXbG5hSFE5SWpJMU5pSWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5UWWdNalUySWlCbWFXeHNQU0p1YjI1bElpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBnbzhjbVZqZENCM2FXUjBhRDBpTWpVMklpQm9aV2xuYUhROUlqSTFOaUlpSUhKNFBTSTBNQ0lpSUdacGJHdzlJaU0yTmpkbFpXRWlMejRLUEhCaGRHZ2dSRDBpVFRFeU9DQTBORXd4TXpNdU1qa3hOREF1Tmkwek5EVXRMamN5TFRrNUxqWXRORGN0TmpJdU5UTXROREJqTFRNdU1qSXRNemt1TURZdE1UVXVNell0T0RrdU56VXRNek11T1RVdE9UUXVNemo9IiwKICAgICAgInNpemVzIjogIjI1NngyNTYiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVGc0SWlCb1pXbG5hSFE5SWpFNE5DSWlJSFpwWlhkQ2IzZzlJakFnTUNBME9EQWdORGd3SWlCbWFXeHNQU0p1YjI1bElpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBnbzhjbVZqZENCM2FXUjBhRDBpTkRnd0lpQm9aV2xuYUhROUlqUTRNQ0lpSUhKNFBTSTRNQ0lpSUdacGJHdzlJaU0yTmpkbFpXRWlMejRLUEhCaGRHZ2dSRDBpVFRJME1DQXhNVGRoTWpObE1URXVORGsxTlRGdE1UWXVNRE5FVFRKUU1qQnZNamQ1TnpnMmVHWlNjVE1tQzJWck9Ga3FaWE5LVlM1TlUxbzNOWFp6VTFjYVRuc3FOalkwWWpwS1VtaHFWM1JxVFVOdE5rMWpSV0pqVVRkMWJuWlFjV1p1YjNkRFFXNTRhMnRCWVZNOUlRPT0iLAogICAgICAic2l6ZXMiOiAiNDgweDQ4MCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1UWTNJQ0JvWldsbmFIUTlJakUyTnlJZ2RtbGxkMEp2ZUQwaU1DQXdJRUUyTnlBMk55SWdabWxzYkQwaWJtOXVaU0lnZUcxc2JuTTlJbWgwZEhBNkx5OTNkM2N1ZHpNdWIzSm5Mekl3TURBDMM5emRtY2lQZ281UEhKbFkzUWdkMmxrZEdnOUlqRTJOeUlpWVdSb1pXbG5hSFE5SWpFMk55SWlJSEo0UFNJeE5pSWlJR1pwYkd3OUlpTTJOamRsWldFaUx6NEtQSEJoZEdnZ1JEMGlUVGd6TGpVZ05ERlNNekZ1TnprdE1USXVORGxMVG01V1pXdGphSEkwTlVreE9XbG5jMkpGSlNrUWxEV1pVNEtTbWRXZFR0TkNiZDc5c3E5UzVFNzNjV3YrY25kZGNKRkMyVXlqMVpiMCtzVFJJUmVTcklJZVJJSkM5OVY0UTFNYTVnZGZkSUNhWHd3eUVtZmhQdEppSWdabWxzYkQwaWQyaHBkR1VpTHo0S1VENT0iLAogICAgICAic2l6ZXMiOiAiMTY3eDE2NyIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXSwKICAiY2F0ZWdvcmllcyI6IFsibGlmZXN0eWxlIiwgInV0aWxpdGllcyIsICJwcm9kdWN0aXZpdHkiXSwKICAicmVsYXRlZF9hcHBsaWNhdGlvbnMiOiBbXSwKICAicHJlZmVyX3JlbGF0ZWRfYXBwbGljYXRpb25zIjogZmFsc2UKfQ==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1em;
        }

        .pwa-install {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .pwa-install h3 {
            color: white;
            margin-bottom: 10px;
        }

        .pwa-install p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        .btn-install {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-install:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .offline-indicator {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .notification-setup {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .notification-setup h3 {
            color: white;
            margin-bottom: 10px;
        }

        .notification-setup p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        .btn-notification {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-notification:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .question {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .question.great {
            color: #4CAF50;
        }

        .question.shit {
            color: #FF6B6B;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-save {
            background: #4CAF50;
            color: white;
        }

        .btn-save:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn-share {
            background: #667eea;
            color: white;
        }

        .btn-share:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .history {
            margin-top: 30px;
        }

        .history h2 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .history-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .history-content {
            margin-bottom: 8px;
        }

        .history-great {
            color: #4CAF50;
            font-weight: 600;
        }

        .history-shit {
            color: #FF6B6B;
            font-weight: 600;
        }

        .success-message {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .update-available {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .update-available button {
            background: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .card {
                padding: 20px;
            }

            .buttons {
                flex-direction: column;
            }

            .auto-save-indicator {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Daily Reflection</h1>
            <p>Take a moment to reflect on your day</p>
        </div>

        <!-- PWA Install Prompt -->
        <div class="pwa-install" id="pwaInstall">
            <h3>📱 Install App</h3>
            <p>Add Daily Reflection to your home screen for the best experience</p>
            <button class="btn-install" id="installBtn">Install App</button>
        </div>

        <!-- Update Available -->
        <div class="update-available" id="updateAvailable">
            <span>🔄 App update available!</span>
            <button onclick="updateApp()">Update Now</button>
        </div>

        <!-- Offline Indicator -->
        <div class="offline-indicator" id="offlineIndicator">
            📱 You're offline - app continues to work!
        </div>

        <div class="notification-setup" id="notificationSetup">
            <h3>Enable Evening Reminders</h3>
            <p>Get a gentle reminder each evening to reflect on your day</p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn-notification" onclick="enableNotifications()">Enable Notifications</button>
                <button class="btn-notification" onclick="testNotification()" style="opacity: 0.7;">Test Notification</button>
            </div>
        </div>

        <div class="card">
            <div class="question great">What has been great today?</div>
            <textarea id="greatText" placeholder="Share what made today wonderful..."></textarea>
        </div>

        <div class="card">
            <div class="question shit">What has been shit today?</div>
            <textarea id="shitText" placeholder="Let it out... what was challenging today?"></textarea>
        </div>

        <div class="buttons">
            <button class="btn btn-save" onclick="saveReflection()">Save Reflection</button>
            <button class="btn btn-share" onclick="shareReflection()">Share</button>
        </div>

        <div id="successMessage" class="success-message" style="display: none;">
            Reflection saved! 🌟
        </div>

        <div class="history">
            <h2>Your Reflections</h2>
            <div id="historyContainer"></div>
        </div>

        <!-- Auto-save indicator -->
        <div class="auto-save-indicator" id="autoSaveIndicator">Auto-saved</div>
    </div>

    <script>
        let deferredPrompt;
        let autoSaveTimeout;

        // PWA Install functionality
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaInstall').style.display = 'block';
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('pwaInstall').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then((registration) => {
                    console.log('SW registered: ', registration);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                document.getElementById('updateAvailable').style.display = 'block';
                            }
                        });
                    });
                    
                    // Register periodic background sync if supported
                    if ('periodicSync' in registration) {
                        registration.periodicSync.register('daily-reminder-periodic', {
                            minInterval: 24 * 60 * 60 * 1000, // 24 hours
                        }).catch(err => {
                            console.log('Periodic sync not supported:', err);
                        });
                    }
                    
                }).catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }

        // Update app function
        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then((registration) => {
                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
                window.location.reload();
            }
        }

        // Online/Offline detection
        window.addEventListener('online', () => {
            document.getElementById('offlineIndicator').style.display = 'none';
        });

        window.addEventListener('offline', () => {
            document.getElementById('offlineIndicator').style.display = 'block';
        });

        // Get today's key for localStorage
        function getTodayKey() {
            const today = new Date();
            return `reflection_${today.getFullYear()}_${today.getMonth()}_${today.getDate()}`;
        }

        // Auto-save functionality
        function autoSave() {
            const great = document.getElementById('greatText').value;
            const shit = document.getElementById('shitText').value;
            
            if (great || shit) {
                const todayKey = getTodayKey();
                const reflection = {
                    date: new Date().toISOString(),
                    great: great,
                    shit: shit,
                    autoSaved: true
                };
                localStorage.setItem(todayKey, JSON.stringify(reflection));
                
                // Show auto-save indicator
                const indicator = document.getElementById('autoSaveIndicator');
                indicator.classList.add('show');
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Load today's reflection if it exists
        function loadTodaysReflection() {
            const todayKey = getTodayKey();
            const saved = localStorage.getItem(todayKey);
            
            if (saved) {
                const reflection = JSON.parse(saved);
                document.getElementById('greatText').value = reflection.great || '';
                document.getElementById('shitText').value = reflection.shit || '';
            }
        }

        // Save reflection
        function saveReflection() {
            const great = document.getElementById('greatText').value.trim();
            const shit = document.getElementById('shitText').value.trim();
            
            if (!great && !shit) {
                alert('Please write something in at least one field!');
                return;
            }

            const todayKey = getTodayKey();
            const reflection = {
                date: new Date().toISOString(),
                great: great,
                shit: shit,
                autoSaved: false
            };

            localStorage.setItem(todayKey, JSON.stringify(reflection));
            
            // Show success message
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);

            // Refresh history
            loadHistory();
        }

        // Share reflection
        function shareReflection() {
            const great = document.getElementById('greatText').value.trim();
            const shit = document.getElementById('shitText').value.trim();
            
            if (!great && !shit) {
                alert('Please write something to share!');
                return;
            }

            const today = new Date().toLocaleDateString();
            let shareText = `My Daily Reflection - ${today}\n\n`;
            
            if (great) {
                shareText += `🌟 What was great:\n${great}\n\n`;
            }
            
            if (shit) {
                shareText += `💭 What was challenging:\n${shit}\n\n`;
            }
            
            shareText += `#DailyReflection #Mindfulness`;

            // Use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: 'My Daily Reflection',
                    text: shareText
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(shareText);
                });
            } else {
                fallbackShare(shareText);
            }
        }

        // Fallback share method
        function fallbackShare(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Reflection copied to clipboard!');
                }).catch(() => {
                    promptShare(text);
                });
            } else {
                promptShare(text);
            }
        }

        function promptShare(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Reflection copied to clipboard!');
        }

        // Load reflection history
        function loadHistory() {
            const historyContainer = document.getElementById('historyContainer');
            const reflections = [];

            // Get all reflections from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('reflection_')) {
                    const reflection = JSON.parse(localStorage.getItem(key));
                    reflections.push(reflection);
                }
            }

            // Sort by date (newest first)
            reflections.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Display reflections
            if (reflections.length === 0) {
                historyContainer.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center;">No reflections yet. Start your first one above!</p>';
                return;
            }

            historyContainer.innerHTML = reflections.map(reflection => {
                const date = new Date(reflection.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const autoSavedLabel = reflection.autoSaved ? ' (auto-saved)' : '';

                return `
                    <div class="history-item">
                        <div class="history-date">${date}${autoSavedLabel}</div>
                        ${reflection.great ? `<div class="history-content"><span class="history-great">Great:</span> ${reflection.great}</div>` : ''}
                        ${reflection.shit ? `<div class="history-content"><span class="history-shit">Challenging:</span> ${reflection.shit}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Enable notifications
        function enableNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        document.getElementById('notificationSetup').style.display = 'none';
                        
                        // Store notification preference
                        localStorage.setItem('notifications_enabled', 'true');
                        localStorage.setItem('notification_time', '19:00'); // 7 PM
                        
                        // Initialize notification scheduling through service worker
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.ready.then(registration => {
                                // Send message to service worker to set up notifications
                                registration.active.postMessage({
                                    type: 'SETUP_NOTIFICATIONS',
                                    time: '19:00'
                                });
                                
                                // Register for background sync if supported
                                if ('sync' in window.ServiceWorkerRegistration.prototype) {
                                    return registration.sync.register('daily-reminder');
                                }
                            });
                        }
                        
                        // Fallback scheduling for immediate testing
                        scheduleNotification();
                    } else if (permission === 'denied') {
                        alert('Notifications have been blocked. Please enable them in your browser settings to receive daily reminders.');
                    }
                });
            } else {
                alert('Notifications are not supported in this browser');
            }
        }

        // Schedule daily notification
        function scheduleNotification() {
            // This is now primarily a fallback method
            // The main scheduling should be handled by the service worker
            const now = new Date();
            const evening = new Date();
            evening.setHours(19, 0, 0, 0); // 7 PM

            if (now > evening) {
                evening.setDate(evening.getDate() + 1);
            }

            const timeUntilEvening = evening - now;
            
            // Store next notification time for service worker
            localStorage.setItem('next_notification_time', evening.getTime().toString());
            
            // Only use setTimeout as a fallback for immediate testing
            // Real persistent notifications should come from service worker
            setTimeout(() => {
                if (Notification.permission === 'granted') {
                    // Try to use service worker notification first
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification('Daily Reflection Time', {
                                body: 'Time to reflect on your day! What was great and what was challenging?',
                                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                                badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                                tag: 'daily-reminder',
                                vibrate: [200, 100, 200],
                                requireInteraction: true,
                                actions: [
                                    {
                                        action: 'open',
                                        title: 'Open App'
                                    },
                                    {
                                        action: 'close',
                                        title: 'Later'
                                    }
                                ]
                            });
                        }).catch(() => {
                            // Fallback to regular notification
                            new Notification('Daily Reflection Time', {
                                body: 'Time to reflect on your day! What was great and what was challenging?',
                                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                                tag: 'daily-reminder',
                                vibrate: [200, 100, 200]
                            });
                        });
                    } else {
                        // Fallback to regular notification
                        new Notification('Daily Reflection Time', {
                            body: 'Time to reflect on your day! What was great and what was challenging?',
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                            tag: 'daily-reminder',
                            vibrate: [200, 100, 200]
                        });
                    }
                }
                // Schedule next day
                scheduleNotification();
            }, timeUntilEvening);
        }

        // Initialize app
        function initApp() {
            // Check if notifications are enabled and schedule if needed
            const notificationsEnabled = localStorage.getItem('notifications_enabled') === 'true';
            if (notificationsEnabled && Notification.permission === 'granted') {
                document.getElementById('notificationSetup').style.display = 'none';
                
                // Re-initialize notification scheduling on app load
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.active.postMessage({
                            type: 'SETUP_NOTIFICATIONS',
                            time: localStorage.getItem('notification_time') || '19:00'
                        });
                    });
                }
            }

            // Auto-save functionality
            document.getElementById('greatText').addEventListener('input', autoSave);
            document.getElementById('shitText').addEventListener('input', autoSave);

            // Load today's reflection and history
            loadTodaysReflection();
            loadHistory();
        }

        // Initialize when page loads
        window.addEventListener('load', initApp);

        // Hide install prompt if already installed
        window.addEventListener('appinstalled', () => {
            document.getElementById('pwaInstall').style.display = 'none';
        });

        // Test notification function
        function testNotification() {
            if (Notification.permission === 'granted') {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('Daily Reflection Test', {
                            body: 'This is a test notification. If you can see this, notifications are working!',
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                            tag: 'test-notification',
                            vibrate: [200, 100, 200],
                            requireInteraction: true
                        });
                    }).catch(() => {
                        // Fallback to regular notification
                        new Notification('Daily Reflection Test', {
                            body: 'This is a test notification. If you can see this, notifications are working!',
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                            tag: 'test-notification',
                            vibrate: [200, 100, 200]
                        });
                    });
                } else {
                    // Fallback to regular notification
                    new Notification('Daily Reflection Test', {
                        body: 'This is a test notification. If you can see this, notifications are working!',
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNMTYgOEwxNy40NSAxNi4zNUwyNiAxOEwxNy40NSAyNS42NUwxNiAzNEwxNC41NSAyNS42NUw2IDE4TDE0LjU1IDE2LjM1TDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                        tag: 'test-notification',
                        vibrate: [200, 100, 200]
                    });
                }
            } else {
                alert('Please enable notifications first by clicking the "Enable Notifications" button.');
            }
        }
    </script>
</body>
</html>
